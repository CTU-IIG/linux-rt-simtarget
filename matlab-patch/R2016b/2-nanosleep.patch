From b1c0c54d0215449d064981050ed6cd1ef3a98223 Mon Sep 17 00:00:00 2001
From: Martin <prudemar@fel.cvut.cz>
Date: Wed, 12 Apr 2017 17:59:49 +0200
Subject: [PATCH] 2-patch-nanosleep

Model sample loop timing modified. Model timing which uses
'waitForTimerEvent' which subsequently uses 'read' syscall replaced
by 'clock_nanosleep'. This patch should improve RT capabilities of
the running code.

Is's recomended to recheck whether model thread is ended correctly
after quiting the simulation manually
as there might be some mechanism which is suppressed by this change.
Nevertheless the author of this patch did not find any problems.
---
 .../target/codertarget/rtos/src/linuxinitialize.c  | 31 +++++++++++++++++++++-
 1 file changed, 30 insertions(+), 1 deletion(-)

diff --git a/toolbox/target/codertarget/rtos/src/linuxinitialize.c b/toolbox/target/codertarget/rtos/src/linuxinitialize.c
index f2e90f0..4b076eb 100644
--- a/toolbox/target/codertarget/rtos/src/linuxinitialize.c
+++ b/toolbox/target/codertarget/rtos/src/linuxinitialize.c
@@ -1,6 +1,6 @@
 /* Copyright 2013-2016 The MathWorks, Inc. */
 
-
+#include <math.h>
 /* ---------------------------- */
 /* RTOS-specific headers        */
 /* Note: must be included first */
@@ -80,6 +80,34 @@ static void waitForTimerEvent(int fd)
     }
 }
 
+#define PATCH_NANOSLEEP
+#ifdef PATCH_NANOSLEEP
+#define NSEC_PER_SEC    (1000000000) /* The number of nsecs per sec. */
+void *schedulerTask(void* arg){
+	baseRateInfo_t info = *((baseRateInfo_t *)arg);
+	struct timespec t,interval;
+	interval.tv_sec = (long)floor(info.period);
+	interval.tv_nsec = (long)(NSEC_PER_SEC *
+		(info.period - floor(info.period)));
+	printf("**entering patched scheduler task**\n");
+	clock_gettime(CLOCK_MONOTONIC ,&t);
+	while(1){
+		/* wait until next shot */
+		clock_nanosleep(CLOCK_MONOTONIC, TIMER_ABSTIME, &t, NULL);
+
+		/* do the stuff - post the semaphore */
+		sem_post(&baserateTaskSem);
+
+		/* calculate next shot */
+		t.tv_nsec += interval.tv_nsec;
+		t.tv_sec += interval.tv_sec;
+		if (t.tv_nsec >= NSEC_PER_SEC) {
+			t.tv_nsec -= NSEC_PER_SEC;
+			t.tv_sec++;
+		}
+	}
+}
+#else
 void *schedulerTask(void* arg)
 {
     int fd;
@@ -95,6 +123,7 @@ void *schedulerTask(void* arg)
         sem_post(&baserateTaskSem);    
     }
 }
+#endif /* PATCH_NANOSLEEP */
 
 /* Should use this fcn, but currently are not using it */
 /* Why: it is safe ??? from interruption */
-- 
1.9.1

